import './header.css'
import http from '../../common/http'

let template = require('./Header.template')

/*
* return value example:
{
    "code": 0,
    "message": "已经登录",
    "data": {
        "operatorid": "995295777",
        "partyname": "1705041122196944",
        "partyid": "567964615",
        "mobilenumber": "18357114026",
        "partytype": "企业",
        "operator": "admin",
        "realname": "和好如初",
        "accountNumber": "8802000082745"
    },
    "others": {},
    "totalCount": 0
}
*/
function getUserInfo() {
  return http.ajax({
    url: '/treasureWeb/main/getUserSeesion.do',
    type: 'POST'
  }).then((res) => {
    let result = res[0];
    if (result && result.code === 0) {
      let isLogin = result.data ? true : false;
      let loginInfoData = {
        isLogin: isLogin,
        partyname: isLogin ? result.data.partyname ? result.data.partyname : '' : ''
      };
      return loginInfoData
    }
  })
}


function getEnterpriseRole(loginInfoData) {
  return http.ajax({
    url: "/treasureWeb/main/getEnterpriseRole.do",
    type: 'POST'
  }).then((res) => {
    let data = res[0];
    let role = '';

    if (data && data.code === 0) {
      let rolePriorities = ['visitor', '采购商', '供应商', '运营商'];
      let roleDefaultPage = ['/user/orderList.html', '/user/orderList.html', '/seller/orderList.html', '/seller/requirement.html'];
      let roleLevel = -1;
      // loop through all roles of a user
      $(data.data).each(function(index, item) {
        if (item.roleType === '运营商') {
          role = '运营商';
          roleLevel = 3;
        } else if (item.roleType === '供应商') {
          role = '供应商';
          roleLevel > 2 ? '' : roleLevel = 2;
        } else if (item.roleType === '采购商') {
          role = '采购商';
          roleLevel = 1;
          roleLevel > 1 ? '' : roleLevel = 1;
        } else {
          // no role or visitor role
          role = 'visitor';
          ua.url = '';
          loginInfoData.url = '';
          roleLevel = 0;
        }
      });
      loginInfoData.role = rolePriorities[roleLevel]
      loginInfoData.url = roleDefaultPage[roleLevel]

      return loginInfoData
    }
    return null
  })
}

/*
function initPage() {
  getUserInfo().then((res) => {
    return getEnterpriseRole(res)
  }).then((loginInfoData) => {
    $("header").html(template(loginInfoData));
  })
}*/

function isProduct() {
  // if hostname contains 'test' or 'dev', it's not production
  var bIsProduct = window.location.hostname.indexOf('test') === -1 ||
    window.location.hostname.indexOf('dev') === -1
  return bIsProduct
}

function getDomain() {
  return isProduct() ? 'https://passport.tf56.com' : '//sitetest.tf56.com';
}

module.exports = {
  // 1. get login status --> isLogin
  // 2. if already login
  //   2.1 get user name --> partyname
  //   2.2 get user roles --> roles
  //   2.3 get default page url for the login user --> url
  getUserInfo: getUserInfo,
  getEnterpriseRole: getEnterpriseRole,
  render: function(userStatus) {
    console.log(userStatus)
    let html = template(userStatus)
    console.log(`header html: ${html}`)
    return html
  }
}
